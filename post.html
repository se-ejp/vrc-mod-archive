<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>VRC改変アーカイブ - 詳細ページ</title>
    <style>
        body { 
            font-family: sans-serif; 
            margin: 0; 
            padding: 0; 
            background: #f4f7f6; 
            color: #333; 
            overflow-x: hidden; 
        }

        .navbar { 
            background: #2c3e50; 
            padding: 15px 0; 
            text-align: center; 
            width: 100%; 
            margin-bottom: 20px; 
        }

        .nav-logo { 
            color: white; 
            text-decoration: none; 
            font-size: 1.5rem; 
            font-weight: bold; 
        }

        .container { 
            max-width: 1000px; 
            margin: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            padding: 0 20px 40px 20px; 
            box-sizing: border-box; 
        }

        /* 投稿タイトル用のスタイル */
        .post-header {
            margin-bottom: 10px;
        }

        .post-title-display {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .section { 
            background: white; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        }

        .edit-form-box { 
            display: none; 
            border: 2px solid #2980b9; 
            padding: 20px; 
            border-radius: 8px; 
            background: white; 
            margin-bottom: 20px; 
        }

        .admin-btn-container { 
            text-align: left; 
        }

        .admin-btn { 
            background: #2980b9; 
            color: white; 
            border: none; 
            padding: 5px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.8rem; 
            opacity: 0.8; 
            margin-bottom: 10px; 
        }

        .admin-btn:hover { 
            opacity: 1; 
        }

        /* 画像スライダー */
        .slider-viewport { 
            position: relative; 
            width: 100%; 
            height: 400px; 
            background: #eee; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid #eee; 
        }

        .slide-track { 
            display: flex; 
            transition: transform 0.4s ease-in-out; 
            height: 100%; 
        }

        .slide-track img { 
            min-width: 100%; 
            height: 100%; 
            object-fit: contain; 
        }

        .slide-btn { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            background: none; 
            border: none; 
            color: #333; 
            font-size: 40px; 
            cursor: pointer; 
            z-index: 10; 
            text-shadow: 0 0 5px rgba(255,255,255,0.8); 
        }

        .prev { left: 10px; }
        .next { right: 10px; }

        .preview-container { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            margin-bottom: 10px; 
        }

        .thumb-wrapper { 
            position: relative; 
            width: 60px; 
            height: 60px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }

        .thumb-wrapper img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            border-radius: 4px; 
        }

        .del-btn { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: red; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 18px; 
            height: 18px; 
            font-size: 12px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        .drop-zone { 
            width: 100%; 
            height: 50px; 
            border: 2px dashed #2980b9; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #2980b9; 
            margin-bottom: 10px; 
            cursor: pointer; 
            font-size: 0.8rem; 
        }

        input, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }

        .url-input-group { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 5px; 
        }

        .url-btn { 
            padding: 5px 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
        }

        .add-url-btn { 
            background: #27ae60; 
            color: white; 
            margin-bottom: 10px; 
        }

        .remove-url-btn { 
            background: #e74c3c; 
            color: white; 
            height: 38px; 
        }

        .ref-link-box { 
            margin-top: 20px; 
            padding-top: 15px; 
            border-top: 1px dashed #eee; 
        }

        .ref-link-box ul { 
            padding-left: 20px; 
            margin: 5px 0 0 0; 
        }

        .ref-link-box a { 
            color: #2980b9; 
            text-decoration: none; 
            font-size: 0.9rem; 
        }

        .ref-link-box a:hover { 
            text-decoration: underline; 
        }

        .comment-group { 
            margin-top: 15px; 
            border-top: 1px solid #eee; 
            padding-top: 15px; 
        }

        .parent-comment { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
        }

        .reply-area { 
            display: none; 
            margin-left: 40px; 
            border-left: 3px solid #dee2e6; 
            padding-left: 20px; 
        }

        .toggle-replies-btn { 
            background: none; 
            border: none; 
            color: #065fd4; 
            cursor: pointer; 
            font-weight: bold; 
        }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="index.html" class="nav-logo">VRC改変アーカイブ</a>
</nav>

<div class="container">
    <div class="post-header">
        <h1 id="display-title" class="post-title-display">（タイトルなし）</h1>
    </div>

    <div class="admin-btn-container">
        <button class="admin-btn" onclick="toggleEditForm()">✎ 投稿内容を編集する</button>
    </div>

    <div id="edit-form" class="edit-form-box">
        <h3>投稿の編集</h3>
        
        <label>投稿タイトル</label>
        <input type="text" id="input-title" placeholder="例：サイバーパンク風改変">

        <label>アバター名</label>
        <input type="text" id="input-avatar" placeholder="例：マヌカ">

        <label>参考URL</label>
        <div id="url-input-list"></div>
        <button type="button" class="url-btn add-url-btn" onclick="addUrlInput('')">＋ URLを追加</button>

        <label>メイン画像</label>
        <div id="prev-main" class="preview-container"></div>
        <div id="drop-main" class="drop-zone">画像をドロップ</div>
        
        <label>解説画像</label>
        <div id="prev-sub" class="preview-container"></div>
        <div id="drop-sub" class="drop-zone">画像をドロップ</div>
        
        <label>解説テキスト</label>
        <textarea id="input-method" rows="4" placeholder="改変の手順を入力してください"></textarea>
        
        <button onclick="updatePost()" style="background: #27ae60; color: white; padding: 12px; border: none; border-radius: 5px; width: 100%; cursor: pointer; font-weight: bold;">保存して反映</button>
    </div>

    <div style="display: flex; gap: 20px;">
        <div class="slider-viewport" style="flex: 1.5;">
            <button class="slide-btn prev" onclick="moveSlide('main', -1)">❮</button>
            <div class="slide-track" id="main-track"></div>
            <button class="slide-btn next" onclick="moveSlide('main', 1)">❯</button>
        </div>
        <div class="section" style="flex: 1;">
            <h3>詳細</h3>
            <p>アバター: <span id="display-avatar">（未入力）</span></p>
        </div>
    </div>

    <div class="section">
        <h3>改変方法</h3>
        <p id="display-text">手順がここに表示されます。</p>
        <div id="sub-slider-container" class="slider-viewport" style="height: 300px; display: none; margin-bottom: 15px;">
            <button class="slide-btn prev" onclick="moveSlide('sub', -1)">❮</button>
            <div class="slide-track" id="sub-track"></div>
            <button class="slide-btn next" onclick="moveSlide('sub', 1)">❯</button>
        </div>

        <div id="ref-box" class="ref-link-box" style="display: none;">
            <strong>参考にした投稿:</strong>
            <ul id="display-ref-list"></ul>
        </div>
    </div>

    <div class="section">
        <h3>コメント</h3>
        <div class="comment-group">
            <div class="parent-comment"><strong>ユーザーA:</strong> わかりやすいですね！</div>
            <button class="toggle-replies-btn" onclick="toggleReplies(this)">▼ 返信を表示</button>
            <div class="reply-area">
                <p><strong>投稿者:</strong> ありがとうございます！</p>
            </div>
        </div>
    </div>
</div>

<script>
    let postData = { title: "", avatarName: "", refUrls: [], methodText: "", mainImgs: [], subImgs: [] };
    const currentPos = { main: 0, sub: 0 };

    window.onload = () => {
        // 本来はURLからIDを取得しますが、一旦これまで通り1件分を読み込みます
        const saved = localStorage.getItem('vrc_post_data'); 
        if (saved) {
            postData = JSON.parse(saved);
            if (!postData.refUrls) postData.refUrls = [];
            
            document.getElementById('input-title').value = postData.title || "";
            document.getElementById('input-avatar').value = postData.avatarName || "";
            document.getElementById('input-method').value = postData.methodText || "";
            
            const list = document.getElementById('url-input-list');
            list.innerHTML = "";
            postData.refUrls.forEach(url => addUrlInput(url));
            if (postData.refUrls.length === 0) addUrlInput('');

            renderAll();
            updatePreview('main');
            updatePreview('sub');
        }
    };

    function addUrlInput(value = '') {
        const list = document.getElementById('url-input-list');
        const div = document.createElement('div');
        div.className = 'url-input-group';
        div.innerHTML = `<input type="url" class="ref-url-input" value="${value}" placeholder="https://..."><button type="button" class="url-btn remove-url-btn" onclick="this.parentElement.remove()">－</button>`;
        list.appendChild(div);
    }

    function toggleEditForm() {
        const f = document.getElementById('edit-form');
        f.style.display = (f.style.display === "none" || f.style.display === "") ? "block" : "none";
    }

    function toggleReplies(btn) {
        const area = btn.nextElementSibling;
        const isHidden = area.style.display === "none" || area.style.display === "";
        area.style.display = isHidden ? "block" : "none";
        btn.innerText = isHidden ? "▲ 返信を隠す" : "▼ 返信を表示";
    }

    function updatePreview(key) {
        const imgs = key === 'main' ? postData.mainImgs : postData.subImgs;
        const p = document.getElementById(key === 'main' ? 'prev-main' : 'prev-sub');
        p.innerHTML = imgs.map((src, i) => `
            <div class="thumb-wrapper">
                <img src="${src}">
                <button class="del-btn" onclick="removeImg('${key}', ${i})">×</button>
            </div>
        `).join('');
    }

    window.removeImg = (key, index) => {
        if (key === 'main') postData.mainImgs.splice(index, 1);
        else postData.subImgs.splice(index, 1);
        updatePreview(key);
    };

    ['main', 'sub'].forEach(key => {
        const z = document.getElementById('drop-' + key);
        z.ondragover = e => e.preventDefault();
        z.ondrop = e => {
            e.preventDefault();
            [...e.dataTransfer.files].forEach(file => {
                if (file.type.startsWith('image/')) {
                    const r = new FileReader();
                    r.onload = ev => { 
                        if (key === 'main') postData.mainImgs.push(ev.target.result);
                        else postData.subImgs.push(ev.target.result);
                        updatePreview(key); 
                    };
                    r.readAsDataURL(file);
                }
            });
        };
    });

    window.moveSlide = (key, dir) => {
        const imgs = key === 'main' ? postData.mainImgs : postData.subImgs;
        if (imgs.length <= 1) return;
        currentPos[key] = (currentPos[key] + dir + imgs.length) % imgs.length;
        document.getElementById(key + '-track').style.transform = `translateX(-${currentPos[key] * 100}%)`;
    };

    function renderAll() {
        document.getElementById('display-title').innerText = postData.title || "（タイトルなし）";
        document.getElementById('display-avatar').innerText = postData.avatarName || "（未入力）";
        
        const refBox = document.getElementById('ref-box');
        const refList = document.getElementById('display-ref-list');
        refList.innerHTML = "";
        if (postData.refUrls && postData.refUrls.length > 0) {
            refBox.style.display = "block";
            postData.refUrls.forEach(url => {
                if(url.trim()){
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
                    refList.appendChild(li);
                }
            });
        } else {
            refBox.style.display = "none";
        }

        document.getElementById('display-text').innerText = postData.methodText || "手順がここに表示されます。";
        document.getElementById('main-track').innerHTML = postData.mainImgs.map(src => `<img src="${src}">`).join('');
        
        const subTrack = document.getElementById('sub-track');
        const subContainer = document.getElementById('sub-slider-container');
        if (postData.subImgs.length > 0) {
            subContainer.style.display = "block";
            subTrack.innerHTML = postData.subImgs.map(src => `<img src="${src}">`).join('');
        } else {
            subContainer.style.display = "none";
        }
    }

    function updatePost() {
        postData.title = document.getElementById('input-title').value;
        postData.avatarName = document.getElementById('input-avatar').value;
        postData.methodText = document.getElementById('input-method').value;
        
        const urlInputs = document.querySelectorAll('.ref-url-input');
        postData.refUrls = Array.from(urlInputs).map(input => input.value).filter(val => val.trim() !== "");
        
        localStorage.setItem('vrc_post_data', JSON.stringify(postData));
        renderAll();
        toggleEditForm();
        alert("保存しました！");
    }
</script>
</body>
</html>