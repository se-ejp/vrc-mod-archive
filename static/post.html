<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VRCæ”¹å¤‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– - è©³ç´°</title>
    <link rel="stylesheet" href="common.css">
    <style>
        /* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        .container { max-width: 1100px; margin: auto; padding: 0 20px 40px 20px; box-sizing: border-box; }
        .btn-back { display: inline-block; text-decoration: none; color: #00f2ff; font-weight: bold; margin: 20px 0; transition: 0.3s; opacity: 0.8; }
        .btn-back:hover { opacity: 1; text-shadow: 0 0 8px #00f2ff; }
        .post-header { display: flex; align-items: center; gap: 20px; margin: 20px 0; justify-content: space-between; }
        .post-title-display { font-size: 2rem; font-weight: bold; color: #fff; text-shadow: 0 0 12px rgba(0, 242, 255, 0.8); margin: 0; }

        /* --- ã‚¿ã‚°è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« --- */
        .post-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag-link { background: rgba(0, 242, 255, 0.1); color: #00f2ff; border: 1px solid rgba(0, 242, 255, 0.3); padding: 3px 10px; border-radius: 4px; font-size: 0.8rem; text-decoration: none; transition: 0.3s; }
        .tag-link:hover { background: rgba(0, 242, 255, 0.2); border-color: #00f2ff; box-shadow: 0 0 8px rgba(0, 242, 255, 0.4); }

        /* --- æŠ•ç¨¿è€…æƒ…å ±ã®ãƒ›ãƒãƒ¼è¨­å®š --- */
        .author-link { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            text-decoration: none; 
            transition: 0.3s; 
            opacity: 0.9;
        }
        .author-link:hover { 
            opacity: 1; 
            filter: drop-shadow(0 0 5px rgba(0, 242, 255, 0.5));
        }
        .author-link:hover .author-avatar {
            border-color: #fff;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.8);
        }
        .author-link:hover .author-name {
            color: #00f2ff !important;
        }
        .author-avatar { transition: 0.3s; }

        /* --- ã„ã„ã­ãƒœã‚¿ãƒ³ --- */
        .actions-bar { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .btn-like {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 77, 109, 0.3); color: #fff;
            padding: 8px 18px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; font-weight: bold;
        }
        .btn-like:hover { background: rgba(255, 77, 109, 0.1); border-color: #ff4d6d; }
        .btn-like.active { background: rgba(255, 77, 109, 0.2); border-color: #ff4d6d; color: #ff4d6d; box-shadow: 0 0 15px rgba(255, 77, 109, 0.4); }

        /* --- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  --- */
        .edit-form-box { display: none; width: 100%; background: rgba(10, 15, 30, 0.98); padding: 30px; border: 2px solid #00f2ff; border-radius: 8px; margin-bottom: 30px; box-sizing: border-box; z-index: 2000; position: relative; }
        .edit-form-box label { display: block; margin-top: 15px; color: #00f2ff; font-size: 0.85rem; font-weight: bold; }
        .edit-form-box input, .edit-form-box textarea { width: 100%; padding: 12px; margin-top: 5px; background: rgba(255,255,255,0.05); border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 4px; color: #fff; box-sizing: border-box; font-family: inherit; outline: none; }
        
        .row-item { display: flex; gap: 8px; margin-top: 8px; align-items: stretch; }
        .row-item input { margin-top: 0 !important; flex: 1; }
        
        .btn-row-del { 
            background: #ff4d4d; color: white; border: none; width: 44px; border-radius: 4px; 
            cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .btn-add-row { background: #00d28d; border: none; padding: 10px 18px; border-radius: 4px; color: white; cursor: pointer; margin-top: 10px; font-weight: bold; font-size: 0.85rem; }

        /* --- è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- */
        .section { background: rgba(15, 23, 42, 0.7); padding: 25px; border-radius: 8px; border: 1px solid rgba(0, 242, 255, 0.2); backdrop-filter: blur(10px); margin-bottom: 20px; }
        h3 { color: #00f2ff; margin-top: 0; border-left: 4px solid #00f2ff; padding-left: 10px; font-size: 1.2rem; }

        /* ãƒªãƒ³ã‚¯ã®ãƒ›ãƒãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ */
        #display-used-list a, #display-ref-list a { 
            color: #fff; 
            text-decoration: none; 
            transition: 0.2s; 
        }
        #display-used-list a:hover, #display-ref-list a:hover { 
            color: #00f2ff; 
            text-decoration: none; 
        }

        /* --- ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ --- */
        .comment-item { display: flex; gap: 12px; padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); position: relative; }
        .comment-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #00f2ff, #0066ff); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: bold; color: white; flex-shrink: 0; }
        .comment-info { flex: 1; display: flex; flex-direction: column; }
        .comment-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; }
        .comment-author { color: #00f2ff; font-size: 0.85rem; font-weight: bold; text-decoration: none; cursor: pointer; }
        .comment-author:hover { text-decoration: underline; }
        .comment-date { color: rgba(255, 255, 255, 0.3); font-size: 0.7rem; margin-left: 8px; }
        .comment-text { color: #fff; line-height: 1.5; margin-bottom: 8px; white-space: pre-wrap; }
        .comment-actions { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; min-height: 32px; }
        
        .btn-reply-trigger { background: rgba(0, 242, 255, 0.1); border: 1px solid rgba(0, 242, 255, 0.4); color: #fff; cursor: pointer; padding: 5px 14px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; transition: 0.3s; }
        .btn-reply-trigger:hover { background: rgba(0, 242, 255, 0.3); border-color: #00f2ff; }
        
        .toggle-replies-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .toggle-replies-btn:hover { color: #00f2ff; }
        
        .replies-container { display: none; margin-top: 10px; border-left: 2px solid rgba(255, 255, 255, 0.1); padding-left: 15px; }
        .reply-item { display: flex; gap: 10px; padding: 8px 0; }
        .reply-avatar { width: 24px; height: 24px; border-radius: 50%; background: #444; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; color: white; flex-shrink: 0; }
        .comment-menu-trigger { background: none; border: none; color: rgba(255, 255, 255, 0.4); cursor: pointer; padding: 0 8px; font-size: 1.2rem; }
        .comment-dropdown { position: absolute; right: 10px; top: 45px; background: #1a1f2e; border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 4px; display: none; flex-direction: column; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .comment-dropdown button { background: none; border: none; color: #fff; padding: 12px 24px; text-align: left; cursor: pointer; font-size: 0.9rem; }
        .reply-input-box { display: none; margin-top: 15px; padding: 12px; background: rgba(0, 242, 255, 0.05); border-radius: 4px; border-left: 4px solid #00f2ff; }
        .reply-textarea { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(0, 242, 255, 0.3); color: #fff; padding: 10px; border-radius: 4px; font-size: 0.9rem; box-sizing: border-box; font-family: inherit; resize: vertical; }

        /* --- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ --- */
        .slider-outer { position: relative; padding: 0 45px; }
        .slider-viewport { width: 100%; height: 500px; background: #000; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .slide-track { display: flex; transition: transform 0.4s ease-in-out; height: 100%; }
        .slide-track img { min-width: 100%; height: 100%; object-fit: contain; }
        
        /* çŸ¢å°ã®ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¿½åŠ  */
        .slide-btn { 
            position: absolute; 
            top: 50%; 
            transform: translateY(-50%); 
            background: none; 
            border: none; 
            font-size: 40px; 
            color: #00f2ff; 
            cursor: pointer; 
            z-index: 10; 
            transition: 0.3s ease; 
            opacity: 0.7;
            outline: none;
        }
        .slide-btn:hover { 
            opacity: 1; 
            transform: translateY(-50%) scale(1.1); 
            text-shadow: 0 0 15px rgba(0, 242, 255, 0.8), 0 0 5px #fff;
        }
        .prev { left: 0px; } .next { right: 0px; }

        .thumb-wrapper { position: relative; width: 80px; height: 80px; border: 1px solid #00f2ff; border-radius: 4px; overflow: hidden; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .btn-edit-trigger { display: none; background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: #fff; border: none; padding: 10px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; }

        @media (max-width: 850px) { .main-content { flex-direction: column; } .slider-viewport { height: 350px; } }
    </style>
</head>
<body onclick="closeAllMenus(event)">

<div class="bg-fixed"></div>
<nav class="navbar">
    <a href="index.html" class="nav-logo">VRCæ”¹å¤‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</a>
    <div id="user-display" class="user-menu-container"></div>
</nav>

<div class="container">
    <a href="list.html" class="btn-back">â† æŠ•ç¨¿ä¸€è¦§ã«æˆ»ã‚‹</a>

    <div style="margin-bottom: 25px;">
        <div class="post-header">
            <h1 id="display-title" class="post-title-display">èª­ã¿è¾¼ã¿ä¸­...</h1>
            <button onclick="toggleEdit()" class="btn-edit-trigger" id="edit-trigger-btn">âœ ç·¨é›†ã™ã‚‹</button>
        </div>
        <div id="display-tags" class="post-tags"></div>
    </div>

    <div class="actions-bar">
        <button id="like-button" class="btn-like" onclick="toggleLike()">â¤ï¸ <span id="like-count">0</span></button>
    </div>

    <div id="edit-form" class="edit-form-box">
        <h3>ç·¨é›†ãƒšãƒ¼ã‚¸</h3>
        <label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="input-title">
        <label>ã‚¢ãƒã‚¿ãƒ¼å</label><input type="text" id="input-avatar">
        
        <label>ã‚¿ã‚°ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰</label><input type="text" id="input-tags" placeholder="ä¾‹: ã‚¯ãƒ¼ãƒ« æ¸…æ¥š æ”¹å¤‰">

        <label>ä½¿ç”¨ã—ãŸã‚‚ã®</label>
        <div id="used-items-edit-list"></div>
        <button onclick="addUsedItemInput()" class="btn-add-row">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>

        <label>ãƒ¡ã‚¤ãƒ³ç”»åƒ</label>
        <div id="preview-main-edit" class="preview-container"></div>
        <div class="drop-zone" id="drop-main" style="border:1px dashed #00f2ff; padding:20px; text-align:center; margin-top:5px; color:#00f2ff;">ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>

        <label>è§£èª¬ãƒ†ã‚­ã‚¹ãƒˆ</label><textarea id="input-method" rows="6"></textarea>
        
        <label>è§£èª¬ç”»åƒ</label>
        <div id="preview-sub-edit" class="preview-container"></div>
        <div class="drop-zone" id="drop-sub" style="border:1px dashed #00f2ff; padding:20px; text-align:center; margin-top:5px; color:#00f2ff;">ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>

        <label style="margin-top: 25px;">å‚è€ƒæŠ•ç¨¿</label>
        <div id="ref-urls-edit-list"></div>
        <button onclick="addRefUrlInput()" class="btn-add-row">ï¼‹ URLã‚’è¿½åŠ </button>

        <div style="margin-top:30px; display:flex; gap:15px;">
            <button onclick="updatePost()" style="flex:2; background:#00d2ff; color:#fff; border:none; padding:15px; border-radius:4px; font-weight:bold; cursor:pointer; transition:0.3s;">å¤‰æ›´ã‚’ä¿å­˜</button>
            <button onclick="toggleEdit()" style="flex:1; background:#4a5568; color:white; border:none; padding:15px; border-radius:4px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <button onclick="deletePost()" style="width:100%; padding:12px; margin-top:20px; background:#ff4d4d; color:white; border:none; border-radius:4px; cursor:pointer;">ã“ã®æŠ•ç¨¿ã‚’å®Œå…¨ã«å‰Šé™¤</button>
    </div>

    <div class="main-content" style="display: flex; gap: 30px; margin-bottom: 25px;">
        <div style="flex: 1.5; min-width: 0;">
            <div class="slider-outer">
                <button class="slide-btn prev" onclick="moveSlide('main', -1)">â®</button>
                <div class="slider-viewport"><div class="slide-track" id="main-track"></div></div>
                <button class="slide-btn next" onclick="moveSlide('main', 1)">â¯</button>
            </div>
        </div>
        <div style="flex: 1;">
            <div class="section">
                <div id="author-container"></div>
                <h3>ã‚¢ãƒã‚¿ãƒ¼ï¼š <span id="display-avatar" style="color:#fff;"></span></h3>
                <h4 style="color:#00f2ff; margin-top:20px;">ä½¿ç”¨ã—ãŸã‚‚ã®</h4>
                <ul id="display-used-list" style="list-style:none; padding:0;"></ul>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>æ”¹å¤‰ã®æ‰‹é †ãƒ»ãƒ¡ãƒ¢</h3>
        <p id="display-method" style="white-space: pre-wrap; line-height:1.8; color:#fff;"></p>
        <div id="sub-slider-area" class="slider-outer" style="display:none; margin-top:30px;">
            <button class="slide-btn prev" onclick="moveSlide('sub', -1)">â®</button>
            <div class="slider-viewport" style="height:350px;"><div class="slide-track" id="sub-track"></div></div>
            <button class="slide-btn next" onclick="moveSlide('sub', 1)">â¯</button>
        </div>
    </div>

    <div id="display-ref-area" class="section" style="display:none;">
        <h3>å‚è€ƒæŠ•ç¨¿</h3>
        <div id="display-ref-list" style="padding:10px 0; display:flex; flex-direction:column; gap:12px;"></div>
    </div>

    <div class="section">
        <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
        <div id="comment-list"></div>
        <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
            <textarea id="comment-body-input" style="background:rgba(255,255,255,0.05); border:1px solid rgba(0,242,255,0.3); color:#fff; padding:12px; border-radius:4px; font-family:inherit;" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
            <button onclick="submitComment()" style="align-self:flex-end; background:#3a7bd5; color:white; border:none; padding:10px 25px; border-radius:4px; cursor:pointer; font-weight:bold;">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    let allPosts = []; let allUsers = []; let currentPost = {}; let postId = null;
    const currentPos = { main: 0, sub: 0 };
    
    window.onload = async () => {
        const params = new URLSearchParams(window.location.search);
        postId = parseInt(params.get('id'));
        try {
            const [pRes, uRes] = await Promise.all([fetch('/api/posts'), fetch('/api/users')]);
            allPosts = await pRes.json();
            allUsers = await uRes.json();
            currentPost = allPosts.find(p => p.id == postId);
            if (currentPost) { 
                renderAll(); checkPermission(); renderComments();
                initDropZone('drop-main', 'main'); initDropZone('drop-sub', 'sub');
                updateLikeUI();
            }
        } catch(e) { console.error(e); }
    };

    function renderAll() {
        const author = allUsers.find(u => u.id === currentPost.authorId) || {};
        const authorName = author.nickname || currentPost.authorName || "ä¸æ˜";
        
        let avatarHtml = author.avatarUrl 
            ? `<img src="${author.avatarUrl}" class="author-avatar" style="width:50px; height:50px; border-radius:50%; border:2px solid #00f2ff; object-fit:cover;">` 
            : `<div class="author-avatar" style="width:50px; height:50px; border-radius:50%; background:#444; color:#fff; display:flex; align-items:center; justify-content:center; border:2px solid #00f2ff;">${(authorName[0] || "?").toUpperCase()}</div>`;
        
        document.getElementById('author-container').innerHTML = `
            <div style="padding-bottom:15px; border-bottom:1px dashed rgba(0,242,255,0.3); margin-bottom:15px;">
                <a href="profile.html?id=${currentPost.authorId}" class="author-link">
                    ${avatarHtml}
                    <div>
                        <div style="font-size:0.7rem; color:#00f2ff; margin-bottom:2px;">POSTED BY</div>
                        <div class="author-name" style="color:#fff; font-weight:bold; transition:0.3s;">${authorName}</div>
                    </div>
                </a>
            </div>`;

        document.getElementById('display-title').innerText = currentPost.title || "ç„¡é¡Œ";
        document.getElementById('display-avatar').innerText = currentPost.avatarName || "æœªè¨­å®š";
        document.getElementById('display-method').innerText = currentPost.methodText || "";
        
        // è¿½åŠ : ã‚¿ã‚°ã®æç”»
        const tagContainer = document.getElementById('display-tags');
        if (currentPost.tags && currentPost.tags.length > 0) {
            tagContainer.innerHTML = currentPost.tags.map(t => `<a href="index.html?tag=${encodeURIComponent(t)}" class="tag-link">#${t}</a>`).join('');
        } else {
            tagContainer.innerHTML = "";
        }

        const refUrls = currentPost.referencePostUrls || [];
        if (refUrls.length > 0) {
            document.getElementById('display-ref-area').style.display = "block";
            document.getElementById('display-ref-list').innerHTML = refUrls.map(url => `<a href="${url}" target="_blank">ğŸ”— ${url}</a>`).join('');
        } else { document.getElementById('display-ref-area').style.display = "none"; }

        document.getElementById('main-track').innerHTML = (currentPost.mainImgs || []).map(src => `<img src="${src}">`).join('');
        if (currentPost.subImgs && currentPost.subImgs.length > 0) {
            document.getElementById('sub-slider-area').style.display = "block";
            document.getElementById('sub-track').innerHTML = currentPost.subImgs.map(src => `<img src="${src}">`).join('');
        }
        document.getElementById('display-used-list').innerHTML = (currentPost.usedItems || []).map(item => `<li><a href="${item.url}" target="_blank">ğŸ”— ${item.name}</a></li>`).join('');
    }

    function toggleEdit() {
        const f = document.getElementById('edit-form');
        if (f.style.display === "none" || f.style.display === "") {
            f.style.display = "block";
            document.getElementById('input-title').value = currentPost.title || "";
            document.getElementById('input-avatar').value = currentPost.avatarName || "";
            document.getElementById('input-method').value = currentPost.methodText || "";
            // è¿½åŠ : ã‚¿ã‚°ã‚’æ–‡å­—åˆ—ã«æˆ»ã—ã¦è¡¨ç¤º
            document.getElementById('input-tags').value = (currentPost.tags || []).join(" ");
            
            document.getElementById('used-items-edit-list').innerHTML = "";
            (currentPost.usedItems || []).forEach(item => addUsedItemInput(item.name, item.url));
            document.getElementById('ref-urls-edit-list').innerHTML = "";
            (currentPost.referencePostUrls || []).forEach(url => addRefUrlInput(url));
            renderEditPreviews('main', currentPost.mainImgs || []);
            renderEditPreviews('sub', currentPost.subImgs || []);
        } else { f.style.display = "none"; }
    }

    function addUsedItemInput(name = "", url = "") {
        const div = document.createElement('div'); div.className = 'row-item';
        div.innerHTML = `<input type="text" class="used-item-name" placeholder="åå‰" value="${name}"><input type="url" class="used-item-url" style="flex:2" placeholder="URL" value="${url}"><button class="btn-row-del" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('used-items-edit-list').appendChild(div);
    }

    function addRefUrlInput(url = "") {
        const div = document.createElement('div'); div.className = 'row-item';
        div.innerHTML = `<input type="url" class="ref-url-input" placeholder="https://..." value="${url}"><button class="btn-row-del" onclick="this.parentElement.remove()">Ã—</button>`;
        document.getElementById('ref-urls-edit-list').appendChild(div);
    }

    async function updatePost() {
        currentPost.title = document.getElementById('input-title').value;
        currentPost.avatarName = document.getElementById('input-avatar').value;
        currentPost.methodText = document.getElementById('input-method').value;
        
        // è¿½åŠ : ã‚¿ã‚°ã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ä¿å­˜
        const tagInput = document.getElementById('input-tags').value;
        currentPost.tags = tagInput.split(/[ ã€€]+/).filter(t => t.trim() !== "");

        currentPost.usedItems = Array.from(document.querySelectorAll('.used-item-name')).map((n, i) => ({ name: n.value, url: document.querySelectorAll('.used-item-url')[i].value })).filter(item => item.name);
        currentPost.referencePostUrls = Array.from(document.querySelectorAll('.ref-url-input')).map(el => el.value).filter(v => v.trim());
        await savePostData(); location.reload();
    }

    /* --- ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ --- */
    function renderComments() {
        const container = document.getElementById('comment-list');
        const currentUserId = localStorage.getItem('userId');
        if (!currentPost.comments || currentPost.comments.length === 0) {
            container.innerHTML = '<p style="color:rgba(255,255,255,0.3); font-size:0.9rem;">ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }
        container.innerHTML = currentPost.comments.map((c, index) => {
            const initial = (c.authorName || "?")[0].toUpperCase();
            const dateStr = c.date ? new Date(c.date).toLocaleString('ja-JP', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : "";
            const isMyComment = (c.authorId === currentUserId || localStorage.getItem('role') === 'admin');
            const replies = c.replies || [];
            return `
                <div class="comment-item">
                    <div class="comment-avatar">${initial}</div>
                    <div class="comment-info">
                        <div class="comment-header">
                            <div><span class="comment-author" onclick="openReplyBox(${index}, '${c.authorName}')">${c.authorName}</span><span class="comment-date">${dateStr}</span></div>
                            ${isMyComment ? `<button class="comment-menu-trigger" onclick="toggleCommentMenu(event, ${index})">â‹®</button>
                            <div class="comment-dropdown" id="dropdown-${index}">
                                <button onclick="deleteComment(${index})" style="color:#ff4d4d;">ğŸ—‘ å‰Šé™¤</button>
                            </div>` : ""}
                        </div>
                        <div class="comment-text">${c.text}</div>
                        <div class="comment-actions">
                            ${replies.length > 0 ? `<button class="toggle-replies-btn" onclick="toggleReplies(event, ${index})">â–¼ ${replies.length} ä»¶ã®è¿”ä¿¡</button>` : "<div></div>"}
                            <button class="btn-reply-trigger" onclick="openReplyBox(${index}, '${c.authorName}')">è¿”ä¿¡</button>
                        </div>
                        <div class="reply-input-box" id="reply-box-${index}">
                            <textarea id="reply-text-${index}" class="reply-textarea" placeholder="${c.authorName}ã•ã‚“ã«è¿”ä¿¡..."></textarea>
                            <div style="text-align:right; margin-top:8px;"><button onclick="submitReply(${index})" style="background:#00f2ff; color:#000; border:none; padding:8px 20px; border-radius:4px; font-weight:bold; cursor:pointer;">æŠ•ç¨¿</button></div>
                        </div>
                        <div class="replies-container" id="replies-container-${index}">
                            ${replies.map(r => `
                                <div class="reply-item">
                                    <div class="reply-avatar">${(r.authorName || "?")[0]}</div>
                                    <div style="flex:1;">
                                        <span class="comment-author" onclick="openReplyBox(${index}, '${r.authorName}')">${r.authorName}</span>
                                        <div class="comment-text" style="font-size:0.85rem;">${r.text}</div>
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    async function submitComment() {
        const input = document.getElementById('comment-body-input');
        if (!input.value.trim()) return;
        if (!currentPost.comments) currentPost.comments = [];
        currentPost.comments.push({ authorId: localStorage.getItem('userId') || 'guest', authorName: localStorage.getItem('userNickname') || "ã‚²ã‚¹ãƒˆ", text: input.value, date: new Date().toISOString(), replies: [] });
        input.value = ""; renderComments(); await savePostData();
    }

    function openReplyBox(index, authorName) {
        document.querySelectorAll('.reply-input-box').forEach(el => el.style.display = 'none');
        const box = document.getElementById(`reply-box-${index}`);
        box.style.display = 'block';
        const textarea = document.getElementById(`reply-text-${index}`);
        textarea.value = `@${authorName} `;
        textarea.focus();
    }

    async function submitReply(index) {
        const input = document.getElementById(`reply-text-${index}`);
        if (!input.value.trim()) return;
        if (!currentPost.comments[index].replies) currentPost.comments[index].replies = [];
        currentPost.comments[index].replies.push({ authorId: localStorage.getItem('userId') || 'guest', authorName: localStorage.getItem('userNickname') || "ã‚²ã‚¹ãƒˆ", text: input.value, date: new Date().toISOString() });
        input.value = ""; renderComments(); await savePostData();
    }

    function toggleReplies(event, index) {
        const container = document.getElementById(`replies-container-${index}`);
        container.style.display = (container.style.display === 'block') ? 'none' : 'block';
    }

    function toggleCommentMenu(event, index) {
        event.stopPropagation(); closeAllMenus();
        document.getElementById(`dropdown-${index}`).style.display = 'flex';
    }

    function closeAllMenus() { document.querySelectorAll('.comment-dropdown').forEach(el => el.style.display = 'none'); }

    async function deleteComment(index) {
        if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { currentPost.comments.splice(index, 1); renderComments(); await savePostData(); }
    }

    /* --- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ»ç”»åƒãƒ»ä¿å­˜ç³» --- */
    function initDropZone(id, key) {
        const zone = document.getElementById(id);
        zone.addEventListener('dragover', e => e.preventDefault());
        zone.addEventListener('drop', e => {
            e.preventDefault();
            Array.from(e.dataTransfer.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = ev => {
                    if (!currentPost[key + 'Imgs']) currentPost[key + 'Imgs'] = [];
                    currentPost[key + 'Imgs'].push(ev.target.result);
                    renderEditPreviews(key, currentPost[key + 'Imgs']);
                };
                reader.readAsDataURL(file);
            });
        });
    }

    function renderEditPreviews(key, imgs) {
        const container = document.getElementById(`preview-${key}-edit`);
        container.innerHTML = imgs.map((src, i) => `<div class="thumb-wrapper"><img src="${src}"><button class="del-btn" style="position:absolute; top:0; right:0; background:#ff4d4d; color:white; border:none; cursor:pointer; width:20px; height:20px; font-size:12px;" onclick="removeImgEdit('${key}', ${index})">Ã—</button></div>`).join('');
    }

    function removeImgEdit(key, index) {
        currentPost[key + 'Imgs'].splice(index, 1); renderEditPreviews(key, currentPost[key + 'Imgs']);
    }

    function moveSlide(key, dir) {
        const imgs = currentPost[key + 'Imgs'] || [];
        if (imgs.length <= 1) return;
        currentPos[key] = (currentPos[key] + dir + imgs.length) % imgs.length;
        document.getElementById(key + '-track').style.transform = `translateX(-${currentPos[key] * 100}%)`;
    }

    async function savePostData() {
        const idx = allPosts.findIndex(p => p.id == postId);
        if (idx !== -1) { allPosts[idx] = currentPost; await fetch('/api/posts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(allPosts) }); }
    }

    async function deletePost() {
        if (!confirm('æŠ•ç¨¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const filtered = allPosts.filter(p => p.id != postId);
        await fetch('/api/posts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(filtered) });
        window.location.href = 'list.html';
    }

    function checkPermission() {
        const userId = localStorage.getItem('userId');
        if (currentPost.authorId === userId || localStorage.getItem('role') === 'admin') {
            document.getElementById('edit-trigger-btn').style.display = 'block';
        }
    }

    function updateLikeUI() {
        const userId = localStorage.getItem('userId') || 'guest';
        document.getElementById('like-count').innerText = currentPost.likes || 0;
        const btn = document.getElementById('like-button');
        if (currentPost.likedBy && currentPost.likedBy.includes(userId)) btn.classList.add('active');
        else btn.classList.remove('active');
    }

    async function toggleLike() {
        const userId = localStorage.getItem('userId') || 'guest';
        if (!currentPost.likedBy) currentPost.likedBy = [];
        const idx = currentPost.likedBy.indexOf(userId);
        if (idx === -1) { currentPost.likedBy.push(userId); currentPost.likes = (currentPost.likes || 0) + 1; }
        else { currentPost.likedBy.splice(idx, 1); currentPost.likes = Math.max(0, (currentPost.likes || 0) - 1); }
        updateLikeUI(); await savePostData();
    }
</script>
</body>
</html>