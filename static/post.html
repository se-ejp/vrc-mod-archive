<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VRCæ”¹å¤‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– - è©³ç´°</title>
    <link rel="stylesheet" href="common.css">
<style>
    /* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
    .container { max-width: 1100px; margin: auto; padding: 0 20px 40px 20px; box-sizing: border-box; }
    .btn-back { display: inline-block; text-decoration: none; color: #00f2ff; font-weight: bold; margin: 20px 0; transition: 0.3s; opacity: 0.8; }
    .post-header { display: flex; align-items: center; gap: 20px; margin: 20px 0; justify-content: space-between; }
    .post-title-display { font-size: 2rem; font-weight: bold; color: #fff; text-shadow: 0 0 12px rgba(0, 242, 255, 0.8); margin: 0; }

    /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ¨ªä¸¦ã³è¨­å®š --- */
    .main-content { display: flex; gap: 30px; margin-bottom: 25px; align-items: stretch; }
    .slider-column { flex: 1.5; min-width: 0; }
    .info-column { flex: 1; display: flex; flex-direction: column; }
    .info-column .section { height: 100%; margin-bottom: 0; box-sizing: border-box; }

    /* --- æŠ•ç¨¿è€…æƒ…å ±ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .author-info-box { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed rgba(0, 242, 255, 0.3); }
    .author-label { font-size: 0.7rem; color: #00f2ff; font-weight: bold; letter-spacing: 0.1em; margin-bottom: 2px; }
    .author-name-text { color: #fff; font-size: 1rem; font-weight: bold; }
    .author-id-text { font-size: 0.7rem; color: rgba(255, 255, 255, 0.4); margin-left: 5px; }

    /* --- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ é–¢ä¿‚ --- */
    .btn-edit-trigger { 
        display: none; background: linear-gradient(135deg, #00d2ff, #3a7bd5); 
        color: #ffffff; border: none; padding: 10px 20px; border-radius: 50px; 
        font-weight: bold; cursor: pointer; transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3); font-size: 0.9rem; border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .edit-form-box { 
        display: none; width: 100%; background: rgba(10, 15, 30, 0.98); 
        padding: 30px; border: 2px solid #00f2ff; border-radius: 8px; margin-bottom: 30px; box-sizing: border-box; 
    }
    .edit-form-box label { display: block; margin-top: 15px; color: #00f2ff; font-size: 0.85rem; font-weight: bold; }
    .edit-form-box input, .edit-form-box textarea { 
        width: 100%; padding: 12px; margin-top: 5px; background: rgba(255,255,255,0.05); 
        border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 4px; color: #fff; box-sizing: border-box; 
    }

    /* å‰Šé™¤ãƒœã‚¿ãƒ³å…±é€š */
    .btn-danger-fill {
        background: #ff4d4d !important;
        color: white !important;
        border: none !important;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
        border-radius: 4px;
    }
    .btn-danger-fill:hover {
        background: #e63939 !important;
        box-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
    }

    /* ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆèƒŒæ™¯é’ãƒ»æ–‡å­—ç™½ï¼‰ */
    .btn-save-fill {
        background: #00f2ff !important;
        color: white !important;
        border: none !important;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
        border-radius: 4px;
    }
    .btn-save-fill:hover {
        background: #00d2dd !important;
        box-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
    }

    /* â˜…index.htmlã¨å®Œå…¨ã«åŒã˜ãƒ‡ã‚¶ã‚¤ãƒ³ã®è¿½å¾“ãƒœã‚¿ãƒ³ */
    .fab-button { 
        position: fixed; right: 30px; bottom: 30px; 
        background: linear-gradient(135deg, #00f2ff, #0066ff); 
        color: white; padding: 15px 25px; border-radius: 50px; 
        display: flex; align-items: center; gap: 8px; 
        box-shadow: 0 0 20px rgba(0, 242, 255, 0.5); z-index: 1000; 
        text-decoration: none; font-weight: bold; transition: all 0.3s;
    }
    .fab-button:hover { transform: scale(1.05); filter: brightness(1.2); }

@media (max-width: 768px) {
        /* .fab-text { display: none; }  â†ã“ã‚Œã‚’æ¶ˆã—ãŸã“ã¨ã§æ–‡å­—ãŒå‡ºã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ */
        .fab-button { 
            padding: 12px 20px; /* ä½™ç™½ã‚’èª¿æ•´ã—ã¦ã‚«ãƒ—ã‚»ãƒ«å‹ã‚’ç¶­æŒ */
            border-radius: 50px; /* ä¸¸(50%)ã§ã¯ãªãã‚«ãƒ—ã‚»ãƒ«(50px)ã« */
            width: auto;         /* æ¨ªå¹…ã‚’è‡ªå‹•ï¼ˆæ–‡å­—ã«åˆã‚ã›ã‚‹ï¼‰ã« */
            height: auto;        /* é«˜ã•ã‚‚è‡ªå‹•ã« */
            bottom: 20px; 
            right: 20px; 
            font-size: 0.9rem;
        }
    }

    .row-item { display: flex; gap: 10px; align-items: center; margin-top: 8px; }
    .row-item input { margin-top: 0 !important; }
    .btn-row-del { width: 40px; height: 40px; flex-shrink: 0; }

    .preview-container { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .thumb-wrapper { position: relative; width: 80px; height: 80px; border: 1px solid #00f2ff; border-radius: 4px; overflow: hidden; }
    .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
    .del-btn { position: absolute; top: 0; right: 0; width: 22px; height: 22px; font-size: 14px; border-bottom-left-radius: 4px; line-height: 1; }

    .section { background: rgba(15, 23, 42, 0.7); padding: 25px; border-radius: 8px; border: 1px solid rgba(0, 242, 255, 0.2); backdrop-filter: blur(10px); margin-bottom: 20px; }
    h3 { color: #00f2ff; margin-top: 0; border-left: 4px solid #00f2ff; padding-left: 10px; font-size: 1.2rem; }
    .used-title { margin: 15px 0 10px 0; font-size: 0.9rem; color: #ffffff !important; }
    #display-used-list, #display-ref-list { list-style: none; padding: 0; }
    #display-used-list li a, #display-ref-list li a { color: #ffffff; text-decoration: none; display: block; padding: 5px 0; transition: color 0.2s ease; }
    #display-used-list li a:hover, #display-ref-list li a:hover { color: #00f2ff; }
    #display-method { white-space: pre-wrap; line-height: 1.8; color: #ffffff; } 
    .comment-text { color: #ffffff; }
    .comment-author { color: #00f2ff; font-size: 0.8rem; margin-bottom: 5px; font-weight: bold; }

    .slider-outer { position: relative; padding: 0 45px; height: 100%; }
    .slider-viewport { width: 100%; height: 500px; background: #000; border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
    .slide-track { display: flex; transition: transform 0.4s ease-in-out; height: 100%; }
    .slide-track img { min-width: 100%; height: 100%; object-fit: contain; }
    .slide-btn { position: absolute; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 40px; color: #00f2ff; cursor: pointer; z-index: 10; text-shadow: 0 0 10px #00f2ff; }
    .prev { left: 0px; } .next { right: 0px; }

    @media (max-width: 850px) { .main-content { flex-direction: column; } .slider-viewport { height: 350px; } .info-column .section { height: auto; } }
    @media (max-width: 768px) {
        .hero { padding: 40px 15px; clip-path: polygon(30px 0%, 100% 0%, 100% calc(100% - 30px), calc(100% - 30px) 100%, 0% 100%, 0% 30px); }
        .btn { padding: 12px 10px; font-size: 0.8rem; flex: 1; }
        .post-grid { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>

<div class="bg-fixed"></div>
<nav class="navbar">
    <a href="index.html" class="nav-logo">VRCæ”¹å¤‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</a>
    <div id="user-display" class="user-menu-container"></div>
</nav>

<a href="create.html" class="fab-button">
    <span class="fab-icon">ï¼‹</span>
    <span class="fab-text">æ–°è¦æŠ•ç¨¿</span>
</a>

<div class="container">
    <a href="list.html" class="btn-back">â† æŠ•ç¨¿ä¸€è¦§ã«æˆ»ã‚‹</a>

    <div class="post-header">
        <h1 id="display-title" class="post-title-display">èª­ã¿è¾¼ã¿ä¸­...</h1>
        <button onclick="toggleEdit()" class="btn-edit-trigger" id="edit-trigger-btn">âœ ç·¨é›†ã™ã‚‹</button>
    </div>

    <div id="edit-form" class="edit-form-box">
        <h3>ç·¨é›†ãƒšãƒ¼ã‚¸</h3>
        <label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="input-title">
        <label>ã‚¢ãƒã‚¿ãƒ¼å</label><input type="text" id="input-avatar">
        
        <label>ä½¿ç”¨ã—ãŸã‚‚ã®</label>
        <div id="used-items-edit-list"></div>
        <button onclick="addUsedItemInput()" style="background:#00d28d; border:none; padding:8px 15px; border-radius:4px; color:white; cursor:pointer; margin-top:10px;">ï¼‹ é …ç›®ã‚’è¿½åŠ </button>
        
        <label>ãƒ¡ã‚¤ãƒ³ç”»åƒ </label>
        <div id="preview-main-edit" class="preview-container"></div>
        <div class="drop-zone" id="drop-main" style="border: 1px dashed #00f2ff; padding: 10px; text-align: center; margin-top: 5px; color:#00f2ff;">ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
        
        <label>è§£èª¬ãƒ†ã‚­ã‚¹ãƒˆ</label>
        <textarea id="input-method" rows="6"></textarea>
        
        <label>è§£èª¬ç”»åƒ</label>
        <div id="preview-sub-edit" class="preview-container"></div>
        <div class="drop-zone" id="drop-sub" style="border: 1px dashed #00f2ff; padding: 10px; text-align: center; margin-top: 5px; color:#00f2ff;">ç”»åƒã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
        
        <label>å‚è€ƒURL</label>
        <div id="url-list-edit"></div>
        <button onclick="addUrlInputEdit()" style="background:#00d28d; border:none; padding:8px 15px; border-radius:4px; color:white; cursor:pointer; margin-top:10px;">ï¼‹ URLã‚’è¿½åŠ </button>
        
        <div style="margin-top:40px; display:flex; gap:15px;">
            <button onclick="updatePost()" class="btn-save-fill" style="flex:2; padding:15px; font-weight:bold;">å¤‰æ›´ã‚’ã™ã¹ã¦ä¿å­˜</button>
            <button onclick="toggleEdit()" style="flex:1; background:#4a5568; color:white; padding:15px; border:none; border-radius:4px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
        <button onclick="deletePost()" class="btn-danger-fill" style="width:100%; padding:12px; margin-top:20px; font-size: 1rem;">ã“ã®æŠ•ç¨¿ã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹</button>
    </div>

    <div class="main-content">
        <div class="slider-column">
            <div class="slider-outer">
                <button class="slide-btn prev" onclick="moveSlide('main', -1)">â®</button>
                <div class="slider-viewport"><div class="slide-track" id="main-track"></div></div>
                <button class="slide-btn next" onclick="moveSlide('main', 1)">â¯</button>
            </div>
        </div>
        <div class="info-column">
            <div class="section">
                <div class="author-info-box">
                    <div class="author-label">POSTED BY</div>
                    <div>
                        <span id="display-author-name" class="author-name-text">---</span>
                        <span id="display-author-id" class="author-id-text">(ID: ---)</span>
                    </div>
                </div>
                <h3>ã‚¢ãƒã‚¿ãƒ¼ï¼š <span id="display-avatar" style="color: #fff;"></span></h3>
                <h4 class="used-title">ä½¿ç”¨ã—ãŸã‚‚ã®</h4>
                <ul id="display-used-list"></ul>
            </div>
        </div>
    </div>

    <div class="section">
        <h3>æ”¹å¤‰ã®æ‰‹é †ãƒ»ãƒ¡ãƒ¢</h3>
        <p id="display-method"></p>
        <div id="sub-slider-area" class="slider-outer" style="display: none; margin-top: 30px;">
            <button class="slide-btn prev" onclick="moveSlide('sub', -1)">â®</button>
            <div class="slider-viewport" style="height: 350px;"><div class="slide-track" id="sub-track"></div></div>
            <button class="slide-btn next" onclick="moveSlide('sub', 1)">â¯</button>
        </div>
    </div>

    <div id="ref-box" class="section" style="display: none;">
        <h3>å‚è€ƒæŠ•ç¨¿</h3>
        <ul id="display-ref-list"></ul>
    </div>

    <div class="section">
        <h3>ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
        <div id="comment-list"></div>
        <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
            <textarea id="comment-body-input" style="background:rgba(255,255,255,0.05); border:1px solid rgba(0,242,255,0.3); color:#fff; padding:12px; border-radius:4px;" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
            <button onclick="submitComment()" style="align-self:flex-end; background:#3a7bd5; color:white; border:none; padding:10px 25px; border-radius:4px; cursor:pointer; font-weight:bold;">æŠ•ç¨¿ã™ã‚‹</button>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    let allPosts = []; let currentPost = {}; let postId = null; const currentPos = { main: 0, sub: 0 };
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        postId = parseInt(params.get('id'));
        fetch('/api/posts').then(res => res.json()).then(data => {
            allPosts = data;
            currentPost = allPosts.find(p => p.id == postId);
            if (currentPost) { 
                renderAll(); checkPermission(); renderComments();
                initDropZone('drop-main', 'main'); initDropZone('drop-sub', 'sub');
            }
        });
    };

    function initDropZone(id, key) {
        const zone = document.getElementById(id);
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            zone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    if (!currentPost[key + 'Imgs']) currentPost[key + 'Imgs'] = [];
                    currentPost[key + 'Imgs'].push(ev.target.result);
                    renderEditPreviews(key, currentPost[key + 'Imgs']);
                };
                reader.readAsDataURL(file);
            });
        });
    }

    function renderAll() {
        // post.html ã® renderAll å†…ã®ä¾‹
        document.getElementById('display-author-name').innerHTML = 
            `<a href="profile.html?id=${currentPost.authorId}" style="color:#00f2ff; text-decoration:none;">${currentPost.authorName}</a>`;
        document.getElementById('display-author-id').innerText = `(ID: ${currentPost.authorId || "---"})`;
        document.getElementById('display-title').innerText = currentPost.title || "ç„¡é¡Œ";
        document.getElementById('display-avatar').innerText = currentPost.avatarName || "æœªè¨­å®š";
        document.getElementById('display-method').innerText = currentPost.methodText || "";
        document.getElementById('main-track').innerHTML = (currentPost.mainImgs || []).map(src => `<img src="${src}">`).join('');
        if (currentPost.subImgs && currentPost.subImgs.length > 0) {
            document.getElementById('sub-slider-area').style.display = "block";
            document.getElementById('sub-track').innerHTML = currentPost.subImgs.map(src => `<img src="${src}">`).join('');
        }
        document.getElementById('display-used-list').innerHTML = (currentPost.usedItems || []).map(item => 
            `<li><a href="${item.url}" target="_blank">ğŸ”— ${item.name}</a></li>`
        ).join('');
        if (currentPost.refUrls && currentPost.refUrls.length > 0) {
            document.getElementById('ref-box').style.display = "block";
            document.getElementById('display-ref-list').innerHTML = currentPost.refUrls.map(url => `<li><a href="${url}" target="_blank">ğŸ”— ${url}</a></li>`).join('');
        }
    }

    function toggleEdit() {
        const f = document.getElementById('edit-form');
        if (f.style.display === "none" || f.style.display === "") {
            f.style.display = "block";
            document.getElementById('input-title').value = currentPost.title || "";
            document.getElementById('input-avatar').value = currentPost.avatarName || "";
            document.getElementById('input-method').value = currentPost.methodText || "";
            document.getElementById('used-items-edit-list').innerHTML = "";
            (currentPost.usedItems || []).forEach(item => addUsedItemInput(item.name, item.url));
            document.getElementById('url-list-edit').innerHTML = "";
            (currentPost.refUrls || []).forEach(url => addUrlInputEdit(url));
            renderEditPreviews('main', currentPost.mainImgs || []);
            renderEditPreviews('sub', currentPost.subImgs || []);
        } else { f.style.display = "none"; }
    }

    function renderEditPreviews(key, imgs) {
        const container = document.getElementById(`preview-${key}-edit`);
        container.innerHTML = imgs.map((src, i) => `<div class="thumb-wrapper"><img src="${src}"><button class="del-btn btn-danger-fill" onclick="removeImgEdit('${key}', ${i})">Ã—</button></div>`).join('');
    }

    function removeImgEdit(key, index) {
        if (key === 'main') currentPost.mainImgs.splice(index, 1);
        else currentPost.subImgs.splice(index, 1);
        renderEditPreviews(key, (key === 'main' ? currentPost.mainImgs : currentPost.subImgs));
    }

    function addUsedItemInput(name = "", url = "") {
        const div = document.createElement('div'); div.className = 'row-item';
        div.innerHTML = `
            <input type="text" class="used-item-name" style="flex:1" placeholder="ã‚¢ã‚¤ãƒ†ãƒ å" value="${name}">
            <input type="url" class="used-item-url" style="flex:2" placeholder="URL" value="${url}">
            <button class="btn-row-del btn-danger-fill" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('used-items-edit-list').appendChild(div);
    }

    function addUrlInputEdit(url = "") {
        const div = document.createElement('div'); div.className = 'row-item';
        div.innerHTML = `
            <input type="url" class="ref-url-input" style="flex:1" placeholder="https://..." value="${url}">
            <button class="btn-row-del btn-danger-fill" onclick="this.parentElement.remove()">Ã—</button>
        `;
        document.getElementById('url-list-edit').appendChild(div);
    }

    function deletePost() {
        if (!confirm('ã“ã®æŠ•ç¨¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
        const filteredPosts = allPosts.filter(p => p.id != postId);
        fetch('/api/posts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(filteredPosts) }).then(() => {
            alert('å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            window.location.href = 'list.html';
        });
    }

    function updatePost() {
        currentPost.title = document.getElementById('input-title').value;
        currentPost.avatarName = document.getElementById('input-avatar').value;
        currentPost.methodText = document.getElementById('input-method').value;
        const itemNames = document.querySelectorAll('.used-item-name');
        const itemUrls = document.querySelectorAll('.used-item-url');
        currentPost.usedItems = [];
        itemNames.forEach((n, i) => { if(n.value) currentPost.usedItems.push({ name: n.value, url: itemUrls[i].value }); });
        const refInputs = document.querySelectorAll('.ref-url-input');
        currentPost.refUrls = [];
        refInputs.forEach(input => { if(input.value) currentPost.refUrls.push(input.value); });
        const idx = allPosts.findIndex(p => p.id == postId);
        allPosts[idx] = currentPost;
        fetch('/api/posts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(allPosts) }).then(() => location.reload());
    }

    function moveSlide(key, dir) {
        const imgs = (key === 'main') ? currentPost.mainImgs : currentPost.subImgs;
        if (!imgs || imgs.length <= 1) return;
        currentPos[key] = (currentPos[key] + dir + imgs.length) % imgs.length;
        document.getElementById(key + '-track').style.transform = `translateX(-${currentPos[key] * 100}%)`;
    }

    function renderComments() {
        const list = document.getElementById('comment-list');
        list.innerHTML = (currentPost.comments || []).map(c => `<div style="border-bottom:1px solid rgba(255,255,255,0.1); padding:15px 0;"><div class="comment-author">${c.authorName}</div><div class="comment-text">${c.text}</div></div>`).join('');
    }

    function submitComment() {
        const text = document.getElementById('comment-body-input').value;
        if (!text.trim()) return;
        if (!currentPost.comments) currentPost.comments = [];
        currentPost.comments.push({ authorName: localStorage.getItem('userName') || "ã‚²ã‚¹ãƒˆ", text: text });
        const idx = allPosts.findIndex(p => p.id == postId);
        allPosts[idx] = currentPost;
        fetch('/api/posts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(allPosts) }).then(() => {
            document.getElementById('comment-body-input').value = ""; renderComments();
        });
    }

    function checkPermission() {
        const userId = localStorage.getItem('userId');
        if (currentPost.authorId === userId || localStorage.getItem('userRole') === 'admin') {
            document.getElementById('edit-trigger-btn').style.display = 'block';
        }
    }
</script>
</body>
</html>