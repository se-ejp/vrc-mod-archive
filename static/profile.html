<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>„Éó„É≠„Éï„Ç£„Éº„É´ - VRCÊîπÂ§â„Ç¢„Éº„Ç´„Ç§„Éñ</title>
    <link rel="stylesheet" href="common.css">
    <style>
        .container { max-width: 1000px; margin: auto; padding: 20px; box-sizing: border-box; min-height: 100vh; }
        
        .profile-header {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(0, 242, 255, 0.3);
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            overflow: hidden;
            padding-bottom: 30px;
        }

        .cover-area {
            width: 100%; height: 200px;
            background: linear-gradient(45deg, #0f172a, #1e293b);
            background-size: cover;
            background-position: center;
            border-bottom: 1px solid rgba(0, 242, 255, 0.2);
        }

        .profile-info-container {
            padding: 0 40px;
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
        }

        .profile-top-meta {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-top: -60px;
            margin-bottom: 20px;
            position: relative;
        }

        .avatar-wrapper { 
            position: relative; 
            flex-shrink: 0;
        }
        .profile-avatar-circle {
            width: 120px; height: 120px;
            background: linear-gradient(135deg, #00f2ff, #0066ff);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 50px; color: white; font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.4);
            border: 5px solid #0f172a;
            overflow: hidden;
        }
        .profile-avatar-circle img { width: 100%; height: 100%; object-fit: cover; }

        .profile-name-id-group {
            flex: 1;
            padding-bottom: 5px;
        }
        .profile-name { font-size: 1.8rem; color: #fff; margin: 0 0 2px; }
        .profile-id { color: rgba(0, 242, 255, 0.6); font-size: 0.9rem; margin: 0; }

        .profile-side-actions {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        #edit-profile-btn { 
            background: rgba(0, 242, 255, 0.1); 
            color: #00f2ff; 
            border: 1px solid #00f2ff; 
            padding: 8px 18px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: 0.3s; 
            font-size: 0.85rem;
            white-space: nowrap;
            margin-top: 15px;
        }

        .profile-main-content { 
            flex: 1; 
            text-align: left; 
            position: relative; 
        }
        
        #profile-bio { 
            color: #cbd5e1; 
            margin: 15px 0; 
            font-size: 1rem; 
            line-height: 1.6; 
            max-width: 800px; 
            white-space: pre-wrap; 
            padding-bottom: 60px; 
        }

        .sns-container { 
            display: flex; 
            flex-direction: row; 
            gap: 12px; 
            position: absolute;
            bottom: 0;
            right: 0;
        }
        .sns-link { 
            text-decoration: none; 
            color: white; 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            font-size: 0.7rem; 
            font-weight: bold; 
            transition: 0.3s; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sns-link:hover { transform: scale(1.1); filter: brightness(1.2); }

        /* --- ÊäïÁ®ø„Ç´„Éº„Éâ„Å®„Çø„Ç∞„ÅÆ„Çπ„Çø„Ç§„É´ --- */
        .section-title { color: #fff; border-left: 4px solid #00f2ff; padding-left: 15px; margin: 40px 0 25px; font-size: 1.3rem; }
        .post-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .post-card { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; text-decoration: none; color: inherit; transition: 0.3s; position: relative; }
        .post-card:hover { transform: translateY(-5px); border-color: #00f2ff; }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #1a1f2e; }

        /* „Çø„Ç∞Ë°®Á§∫ */
        .tag-list { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .tag-item { font-size: 0.7rem; background: rgba(0, 242, 255, 0.1); color: #00f2ff; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(0, 242, 255, 0.2); }

        /* Âõ∫ÂÆöÊäïÁ®øÁî® (‰øÆÊ≠£Ôºö„ÇØ„É™„ÉÉ„ÇØ„ÇíÈòªÂÆ≥„Åó„Å™„ÅÑ„Åü„ÇÅ„ÅÆz-indexË™øÊï¥) */
        .post-card.pinned { border: 2px solid #00f2ff; box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .pinned-badge {
            position: absolute; top: 10px; left: 10px;
            background: #00f2ff; color: #0f172a;
            padding: 2px 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: bold; z-index: 10;
        }
        .pin-button {
            position: absolute; top: 10px; right: 10px;
            background: rgba(15, 23, 42, 0.9); color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 4px 10px; border-radius: 6px;
            font-size: 0.7rem; cursor: pointer; z-index: 20; transition: 0.2s;
        }
        .pin-button:hover { background: #00f2ff; color: #0f172a; border-color: #00f2ff; }

        @media (max-width: 600px) {
            .profile-info-container { padding: 0 20px; }
            .profile-avatar-circle { width: 80px; height: 80px; font-size: 30px; border-width: 3px; }
            .profile-top-meta { margin-top: -40px; gap: 15px; }
            .profile-name { font-size: 1.4rem; }
            .profile-id { font-size: 0.8rem; }
            .sns-link { width: 40px; height: 40px; font-size: 0.6rem; }
            .sns-container { gap: 8px; }
            #profile-bio { font-size: 0.9rem; padding-bottom: 55px; }
            #edit-profile-btn { margin-top: 20px; padding: 6px 12px; font-size: 0.75rem; }
        }

        /* „É¢„Éº„ÉÄ„É´ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: #1a1f2e; padding: 30px; border-radius: 12px; border: 2px solid #00f2ff; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-content label { display: block; color: #00f2ff; font-size: 0.8rem; margin-top: 15px; margin-bottom: 5px; }
        .modal-content input, .modal-content textarea { width: 100%; background: #0f172a; border: 1px solid #334155; color: white; padding: 12px; border-radius: 6px; box-sizing: border-box; margin-bottom: 10px; }

        .modal-upload-zone { 
            width: 100%; height: 100px; border: 2px dashed rgba(0, 242, 255, 0.3); border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; flex-direction: column; 
            cursor: pointer; margin-bottom: 10px; background: rgba(0, 0, 0, 0.2); color: #94a3b8; 
            font-size: 0.8rem; overflow: hidden; position: relative;
        }
        .modal-upload-zone.dragover { border-color: #00f2ff; background: rgba(0, 242, 255, 0.1); color: #fff; }
        .modal-upload-zone img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; }

        .avatar-input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .btn-add-avatar { background: rgba(0, 242, 255, 0.2); color: #00f2ff; border: 1px dashed #00f2ff; padding: 10px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .btn-remove-avatar { background: #ef4444; color: white; border: none; width: 30px; height: 30px; border-radius: 6px; cursor: pointer; flex-shrink: 0; }
        .avatar-info-tag { font-size: 0.85rem; padding: 4px 10px; background: rgba(0, 242, 255, 0.1); border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 4px; display: inline-block; margin-right: 8px; margin-bottom: 8px; }
    </style>
</head>
<body>

<div class="bg-fixed"></div>
<nav class="navbar">
    <a href="index.html" class="nav-logo">VRCÊîπÂ§â„Ç¢„Éº„Ç´„Ç§„Éñ</a>
    <div id="user-display" class="user-menu-container"></div>
</nav>

<div class="container">
    <div class="profile-header">
        <div class="cover-area" id="profile-cover"></div>
        <div class="profile-info-container">
            <div class="profile-top-meta">
                <div class="avatar-wrapper">
                    <div class="profile-avatar-circle" id="avatar-container"><span id="avatar-initial">?</span></div>
                </div>
                <div class="profile-name-id-group">
                    <h1 class="profile-name" id="profile-user-name">Loading...</h1>
                    <div class="profile-id" id="profile-user-id">ID: ----</div>
                </div>
                <div class="profile-side-actions">
                    <button id="edit-profile-btn" onclick="openEditModal()" style="display: none;">„Éó„É≠„Éï„Ç£„Éº„É´Ë®≠ÂÆö</button>
                </div>
            </div>
            <div class="profile-main-content">
                <div id="profile-avatar-tags" style="margin-bottom: 10px;"></div>
                <p id="profile-bio"></p>
                <div class="sns-container" id="profile-sns"></div>
            </div>
        </div>
    </div>
    <h2 class="section-title">ÊäïÁ®ø‰ΩúÂìÅ</h2>
    <div class="post-grid" id="user-post-list"></div>
</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color: #00f2ff; margin-top: 0;">„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆË®≠ÂÆö</h3>
        <label>„Ç´„Éê„ÉºÁîªÂÉè (D&DÂèØ)</label>
        <div class="modal-upload-zone" id="drop-zone-cover" onclick="document.getElementById('file-cover').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'cover')">
            <div id="prompt-cover">„Ç´„Éê„Éº„ÇíÂ§âÊõ¥</div>
            <img id="preview-cover" style="display:none;">
            <input type="file" id="file-cover" style="display:none;" accept="image/*" onchange="uploadImage(this.files[0], 'cover')">
        </div>
        <input type="hidden" id="edit-cover-url">
        
        <label>„Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè (D&DÂèØ)</label>
        <div class="modal-upload-zone" id="drop-zone-avatar" style="width: 80px; height: 80px; border-radius: 50%; margin: 0 auto;" onclick="document.getElementById('file-avatar').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'avatar')">
            <div id="prompt-avatar">üë§</div>
            <img id="preview-avatar" style="display:none;">
            <input type="file" id="file-avatar" style="display:none;" accept="image/*" onchange="uploadImage(this.files[0], 'avatar')">
        </div>
        <input type="hidden" id="edit-avatar-url">

        <label>„Éã„ÉÉ„ÇØ„Éç„Éº„É†</label>
        <input type="text" id="edit-nickname" placeholder="Ë°®Á§∫Âêç">
        <label>‰ΩøÁî®„Ç¢„Éê„Çø„Éº„É™„Çπ„Éà</label>
        <div id="edit-avatar-list-container"></div>
        <button type="button" class="btn-add-avatar" onclick="addAvatarInput()">+ „Ç¢„Éê„Çø„Éº„ÇíËøΩÂä†</button>
        <label>Ëá™Â∑±Á¥π‰ªã</label>
        <textarea id="edit-bio" rows="4"></textarea>
        <label>X (Twitter) URL</label><input type="url" id="edit-x-url">
        <label>BOOTH URL</label><input type="url" id="edit-booth-url">
        <label>VRChat URL</label><input type="url" id="edit-vrc-url">

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button onclick="saveProfile()" style="flex: 2; background: #00f2ff; border: none; padding: 14px; border-radius: 6px; font-weight: bold; cursor: pointer; color: white;">Â§âÊõ¥„Çí‰øùÂ≠ò</button>
            <button onclick="closeEditModal()" style="flex: 1; background: #334155; color: white; border: none; padding: 14px; border-radius: 6px; cursor: pointer;">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>
</div>

<script src="common.js"></script>
<script>
    let currentProfileData = {};

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const targetUserId = params.get('id');
        const myId = localStorage.getItem('userId');
        if (!targetUserId) { window.location.href = 'index.html'; return; }
        if (targetUserId === myId) { document.getElementById('edit-profile-btn').style.display = 'inline-block'; }
        loadProfileData(targetUserId);
    };

    function loadProfileData(userId) {
        fetch('/api/users').then(res => res.json()).then(users => {
            const user = users.find(u => u.id === userId) || { id: userId, name: "„É¶„Éº„Ç∂„Éº" };
            currentProfileData = user;
            renderProfileHeader(user);
        });
        fetch('/api/posts').then(res => res.json()).then(allPosts => {
            const userPosts = allPosts.filter(p => p.authorId === userId);
            renderUserPosts(userPosts);
        });
    }

    function renderProfileHeader(user) {
        const displayName = user.nickname || user.name || "„É¶„Éº„Ç∂„Éº";
        document.getElementById('profile-user-name').innerText = displayName;
        document.getElementById('profile-user-id').innerText = `@${user.id}`;
        document.getElementById('profile-bio').innerText = user.bio || "Ëá™Â∑±Á¥π‰ªã„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ";

        const tagContainer = document.getElementById('profile-avatar-tags');
        tagContainer.innerHTML = '';
        if (user.useAvatars && Array.isArray(user.useAvatars)) {
            user.useAvatars.forEach(av => {
                if (av.name) {
                    const tag = document.createElement('span');
                    tag.className = 'avatar-info-tag';
                    tag.innerHTML = av.url ? `<a href="${av.url}" target="_blank" style="color:#00f2ff; text-decoration:none;">${av.name} üîó</a>` : av.name;
                    tagContainer.appendChild(tag);
                }
            });
        }

        if (user.coverUrl) { document.getElementById('profile-cover').style.backgroundImage = `url('${user.coverUrl}')`; }
        const avatarContainer = document.getElementById('avatar-container');
        if (user.avatarUrl) { avatarContainer.innerHTML = `<img src="${user.avatarUrl}">`; }
        else { avatarContainer.innerHTML = `<span id="avatar-initial">${displayName.substring(0, 1)}</span>`; }
        
        const snsContainer = document.getElementById('profile-sns');
        snsContainer.innerHTML = '';
        const configs = [{k:'xUrl',l:'X',c:'#1DA1F2'},{k:'boothUrl',l:'BOOTH',c:'#fc4d50'},{k:'vrcUrl',l:'VRC',c:'#2bc3d5'}];
        configs.forEach(conf => {
            if (user[conf.k]) {
                const link = document.createElement('a');
                link.href = user[conf.k]; link.target = '_blank'; link.className = 'sns-link';
                link.style.background = conf.c; link.innerText = conf.l;
                snsContainer.appendChild(link);
            }
        });
    }

    function renderUserPosts(posts) {
        const container = document.getElementById('user-post-list');
        const myId = localStorage.getItem('userId');
        const params = new URLSearchParams(window.location.search);
        const isMyProfile = (params.get('id') === myId);

        const pinnedId = currentProfileData.pinnedPostId ? String(currentProfileData.pinnedPostId) : null;
        const sortedPosts = [...posts].sort((a, b) => {
            const aId = String(a.id), bId = String(b.id);
            if (aId === pinnedId) return -1;
            if (bId === pinnedId) return 1;
            return Number(b.id) - Number(a.id);
        });

        container.innerHTML = sortedPosts.length ? sortedPosts.map(post => {
            const isPinned = String(post.id) === pinnedId;
            // ‰øÆÊ≠£Ôºö„Çø„Ç∞Ë°®Á§∫„ÅÆËøΩÂä†
            const tagsHtml = (post.tags || []).map(t => `<span class="tag-item">#${t}</span>`).join('');
            
            return `
                <div class="post-card ${isPinned ? 'pinned' : ''}">
                    ${isPinned ? '<div class="pinned-badge">üìå Âõ∫ÂÆöÊ∏à„Åø</div>' : ''}
                    ${isMyProfile ? `<button class="pin-button" onclick="event.preventDefault(); togglePin('${post.id}')">${isPinned ? 'Ëß£Èô§' : 'üìå Âõ∫ÂÆö'}</button>` : ''}
                    <a href="post.html?id=${post.id}" style="text-decoration:none; color:inherit; display:block;">
                        <img src="${post.mainImgs ? post.mainImgs[0] : ''}" class="card-img">
                        <div style="padding:15px">
                            <h3 style="margin:0; font-size:1.1rem; color:#fff;">${post.title}</h3>
                            <p style="margin:5px 0 0; font-size:0.85rem; color:#94a3b8;">${post.avatarName || ''}</p>
                            <div class="tag-list">${tagsHtml}</div>
                        </div>
                    </a>
                </div>
            `;
        }).join('') : '<p style="color:rgba(255,255,255,0.4); text-align:center; padding:40px; grid-column:1/-1;">ÊäïÁ®ø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>';
    }

    function togglePin(postId) {
        const isCurrentlyPinned = (String(currentProfileData.pinnedPostId) === String(postId));
        const newPinnedId = isCurrentlyPinned ? null : postId;
        const updatedData = { ...currentProfileData, pinnedPostId: newPinnedId };
        
        fetch('/api/users', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(updatedData) 
        })
        .then(() => {
            currentProfileData.pinnedPostId = newPinnedId;
            location.reload();
        });
    }

    // --- ‰ª•‰∏ã„ÄÅÊó¢Â≠ò„ÅÆD&D„Éª„Ç¢„Éê„Çø„Éº„É™„Çπ„ÉàÁ≠â„ÅÆÂá¶ÁêÜ (Â§âÊõ¥„Å™„Åó) ---
    function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
    function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
    function handleDrop(e, type) {
        e.preventDefault(); e.currentTarget.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) { uploadImage(file, type); }
    }
    function uploadImage(file, type) {
        if (!file) return;
        const formData = new FormData(); formData.append('image', file);
        fetch('/api/upload', { method: 'POST', body: formData }).then(res => res.json()).then(result => {
            if (result.url) {
                document.getElementById(`edit-${type}-url`).value = result.url;
                const preview = document.getElementById(`preview-${type}`);
                preview.src = result.url; preview.style.display = 'block';
                document.getElementById(`prompt-${type}`).style.display = 'none';
            }
        });
    }
    function addAvatarInput(name = '', url = '') {
        const container = document.getElementById('edit-avatar-list-container');
        const row = document.createElement('div'); row.className = 'avatar-input-row';
        row.innerHTML = `<input type="text" class="input-av-name" placeholder="„Ç¢„Éê„Çø„ÉºÂêç" value="${name}" style="flex:1"><input type="url" class="input-av-url" placeholder="URL" value="${url}" style="flex:2"><button type="button" class="btn-remove-avatar" onclick="this.parentElement.remove()">√ó</button>`;
        container.appendChild(row);
    }
    function openEditModal() {
        const d = currentProfileData;
        document.getElementById('edit-nickname').value = d.nickname || '';
        document.getElementById('edit-bio').value = d.bio || '';
        document.getElementById('edit-cover-url').value = d.coverUrl || '';
        document.getElementById('edit-avatar-url').value = d.avatarUrl || '';
        document.getElementById('edit-x-url').value = d.xUrl || '';
        document.getElementById('edit-booth-url').value = d.boothUrl || '';
        document.getElementById('edit-vrc-url').value = d.vrcUrl || '';
        const updateP = (t, u) => {
            const p = document.getElementById(`preview-${t}`), m = document.getElementById(`prompt-${t}`);
            if (u) { p.src = u; p.style.display = 'block'; m.style.display = 'none'; }
            else { p.style.display = 'none'; m.style.display = 'block'; }
        };
        updateP('cover', d.coverUrl); updateP('avatar', d.avatarUrl);
        const c = document.getElementById('edit-avatar-list-container');
        c.innerHTML = '';
        if (d.useAvatars && d.useAvatars.length) d.useAvatars.forEach(av => addAvatarInput(av.name, av.url));
        else addAvatarInput();
        document.getElementById('edit-modal').style.display = 'flex';
    }
    function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }
    function saveProfile() {
        const rows = document.querySelectorAll('.avatar-input-row');
        const useAvatars = Array.from(rows).map(r => ({ name: r.querySelector('.input-av-name').value, url: r.querySelector('.input-av-url').value })).filter(av => av.name);
        const updated = { ...currentProfileData, nickname: document.getElementById('edit-nickname').value, bio: document.getElementById('edit-bio').value, coverUrl: document.getElementById('edit-cover-url').value, avatarUrl: document.getElementById('edit-avatar-url').value, useAvatars: useAvatars, xUrl: document.getElementById('edit-x-url').value, boothUrl: document.getElementById('edit-booth-url').value, vrcUrl: document.getElementById('edit-vrc-url').value };
        fetch('/api/users', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(updated) }).then(() => location.reload());
    }
</script>
</body>
</html>