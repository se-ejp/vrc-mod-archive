<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VRC改変アーカイブ - ログイン</title>
<style>
    body { font-family: sans-serif; margin: 0; background-color: #0b0e1a; color: #e0e6ed; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
    .bg-fixed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-image: url('bg-pattern.jpg'); background-size: cover; opacity: 0.5; }
    
    .login-box { 
        background: rgba(15, 23, 42, 0.8); padding: 40px; border-radius: 12px; 
        border: 1px solid rgba(0, 242, 255, 0.3); backdrop-filter: blur(10px);
        width: 100%; max-width: 400px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.2);
    }
    h1 { color: #00f2ff; text-align: center; margin-bottom: 30px; text-shadow: 0 0 10px rgba(0, 242, 255, 0.5); }
    
    .tab-group { display: flex; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: #718096; transition: 0.3s; }
    .tab.active { color: #00f2ff; border-bottom: 2px solid #00f2ff; font-weight: bold; }

    label { display: block; margin-top: 15px; color: #00f2ff; font-size: 0.9rem; }
    input { 
        width: 100%; padding: 12px; margin-top: 5px; background: rgba(255,255,255,0.05); 
        border: 1px solid rgba(0, 242, 255, 0.3); border-radius: 6px; color: #fff; box-sizing: border-box; 
    }
    input:focus { border-color: #00f2ff; outline: none; background: rgba(255,255,255,0.1); }

    .btn-submit { 
        background: linear-gradient(135deg, #00d2ff, #3a7bd5); color: white; 
        padding: 15px; width: 100%; border: none; border-radius: 50px; 
        margin-top: 30px; font-weight: bold; cursor: pointer; transition: 0.3s;
    }
    .btn-submit:hover { transform: scale(1.02); filter: brightness(1.1); box-shadow: 0 5px 15px rgba(0, 210, 255, 0.4); }
    
    .back-link { display: block; text-align: center; margin-top: 20px; color: #718096; text-decoration: none; font-size: 0.8rem; }
    .back-link:hover { color: #00f2ff; }
</style>
</head>
<body>
<div class="bg-fixed"></div>

<div class="login-box">
    <h1 id="page-title">LOGIN</h1>
    
    <div class="tab-group">
        <div id="tab-login" class="tab active" onclick="switchTab('login')">ログイン</div>
        <div id="tab-register" class="tab" onclick="switchTab('register')">新規登録</div>
    </div>

    <form id="auth-form">
        <div id="nickname-area" style="display:none;">
            <label>ニックネーム（表示名）</label>
            <input type="text" id="nickname" placeholder="例：せいご">
        </div>

        <label>ユーザーID</label>
        <input type="text" id="user-id" placeholder="半角英数字" required>
    
        <label>パスワード</label>
        <input type="password" id="password" required>

        <button type="submit" class="btn-submit" id="submit-text">ログインする</button>
    </form>

    <a href="index.html" class="back-link">← ホームへ戻る</a>
</div>

<script>
    // ★重要：ここに追加！現在のモードを覚える箱（変数）を作ります
    let mode = 'login'; 

    // switchTab 関数に ニックネーム欄の表示切り替えを追加
    function switchTab(newMode) {
        mode = newMode; // これで上の let mode に代入されます
        document.getElementById('tab-login').className = mode === 'login' ? 'tab active' : 'tab';
        document.getElementById('tab-register').className = mode === 'register' ? 'tab active' : 'tab';
        document.getElementById('page-title').innerText = mode === 'login' ? 'LOGIN' : 'REGISTER';
        document.getElementById('submit-text').innerText = mode === 'login' ? 'ログインする' : '新しく登録する';
        
        // 登録のときだけニックネーム欄を出す
        document.getElementById('nickname-area').style.display = mode === 'register' ? 'block' : 'none';
    }

    // --- 以下、送信処理（onsubmit）は今のままでOKです ---
    document.getElementById('auth-form').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('user-id').value;
        const pw = document.getElementById('password').value;
        const nickname = document.getElementById('nickname').value; 
        
        const url = mode === 'login' ? '/api/login' : '/api/register';
        const payload = { id: id, password: pw, nickname: nickname };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();

            if (data.status === 'success') {
                if (mode === 'register') {
                    alert("登録完了！ログインしてください。");
                    switchTab('login');
                } else {
                    localStorage.setItem('userId', data.user.id);
                    localStorage.setItem('userNickname', data.user.nickname || data.user.id); 
                    localStorage.setItem('userRole', data.user.role);
                    alert(`ようこそ、${data.user.nickname || data.user.id}さん！`);
                    window.location.href = 'index.html';
                }
            } else {
                alert("エラー: " + data.message);
            }
        } catch (err) { alert("通信失敗"); }
    };
</script>
</body>
</html>